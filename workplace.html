<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Viora â€“ Mein Arbeitsplatz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body class="page-workplace">

  <nav class="sticky-nav">
    <div class="nav-container">
      <div style="display:flex; align-items:center;">
        <a href="dashboard.html" class="logo">
          <img src="logo.png" alt="Viora Logo" class="logo-img">
        </a>
        <div id="user-profile" class="profile-avatar" title="Dein Profil">U</div>
      </div>
      <div class="nav-links">
        <a href="dashboard.html"><span class="icon" aria-hidden="true">ğŸ </span> Home</a>
        <a href="workplace.html" class="active-link"><span class="icon" aria-hidden="true">ğŸ’¼</span> Workplace</a>
        <a href="struktur.html"><span class="icon" aria-hidden="true">ğŸ“…</span> Alltag</a>
        <a href="psyche.html"><span class="icon" aria-hidden="true">ğŸ§ </span> Psyche</a>
        <a href="digital.html"><span class="icon" aria-hidden="true">ğŸ’»</span> Digital</a>
        <a href="index.html" class="icon-only" aria-label="Logout"><span class="icon" aria-hidden="true">â†©</span><span class="sr-only">Logout</span></a>
      </div>
    </div>
  </nav>

  <header class="hero">
    <h1>Arbeitsplatz</h1>
    <p class="subtitle">Deine Aufgaben und dein Team.</p>
  </header>

  <main class="container">

    <div id="loading-view" style="text-align:center;">Lade Daten...</div>
    
    <div id="no-group-view" class="no-group-msg" style="display:none;">
      <div class="icon-placeholder" style="margin: 0 auto 20px;"><span class="icon" aria-hidden="true">ğŸ‘¥</span></div>
      <h2>Noch keine Zuordnung</h2>
      <p>Bitte warte, bis dein Coach dich einer Arbeitsgruppe zugewiesen hat.</p>
      <button onclick="location.reload()" class="primary-btn" style="margin-top:20px;">Neu laden</button>
    </div>

    <div id="workspace-view" style="display:none;">
      <div class="group-banner">
        <div class="group-info">
          <p style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px;">Deine Abteilung</p>
          <h2 id="user-group-name">...</h2>
        </div>
        <div style="font-size: 3rem; opacity: 0.5;"><span class="icon" aria-hidden="true">ğŸ¢</span></div>
      </div>

      <section class="section">
        <h2 class="section-title">Offene Aufgaben</h2>
        <div id="tasks-container" class="task-list"></div>
      </section>
    </div>

  </main>

  <footer class="footer"><p>Â© 2025 Viora.</p></footer>

  <script>
    const DB_KEY = 'VIORA_DB';
    const USER_KEY = 'viora_current_user';
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', () => {
      const userRaw = localStorage.getItem(USER_KEY);
      if(!userRaw) { window.location.href = 'index.html'; return; }
      currentUser = JSON.parse(userRaw);
      
      const avatar = document.getElementById('user-profile');
      if(avatar) avatar.innerText = currentUser.name.charAt(0).toUpperCase();

      loadWorkplaceData();
    });

    function getDB() {
      const raw = localStorage.getItem(DB_KEY);
      if (!raw) return { users: {}, tasks: [] }; 
      return JSON.parse(raw);
    }

    function loadWorkplaceData() {
      const db = getDB();
      document.getElementById('loading-view').style.display = 'none';

      const userData = db.users[currentUser.username];
      if (!userData || !userData.group) {
        document.getElementById('no-group-view').style.display = 'block';
        return;
      }

      document.getElementById('no-group-view').style.display = 'none';
      document.getElementById('workspace-view').style.display = 'block';
      
      const myGroup = userData.group;
      document.getElementById('user-group-name').innerText = myGroup;

      renderTasks(db.tasks, myGroup, currentUser.name);
    }

    function renderTasks(allTasks, myGroup, myName) {
      const container = document.getElementById('tasks-container');
      container.innerHTML = '';

      const myTasks = allTasks.filter(t => {
        const groupMatch = (t.group === myGroup);
        if(!groupMatch) return false;

        const isAssignedSpecifically = (t.assignedTo && t.assignedTo.length > 0);
        if(isAssignedSpecifically) {
          return t.assignedTo.includes(myName);
        }
        return true;
      });

      if (myTasks.length === 0) {
        container.innerHTML = '<p style="color:var(--text-muted); text-align:center;">Alles erledigt! Keine offenen Aufgaben.</p>';
        return;
      }

      myTasks.slice().reverse().forEach(task => {
        const isDone = task.completedBy && task.completedBy.includes(currentUser.name);
        const isPersonal = task.assignedTo && task.assignedTo.length > 0;

        let actionBtn = '';
        let cardClass = 'task-card';
        let badge = isPersonal ? '<span class="personal-badge">PersÃ¶nlich</span>' : '';
        
        // NEU: Datum Logik
        let dateHTML = '';
        if(task.dueDate) {
          dateHTML = `<div class="due-date">ğŸ“… FÃ¤llig bis: ${task.dueDate}</div>`;
        }

        if(isDone) {
          cardClass += ' done';
          actionBtn = '<span style="color:#10b981; font-size:0.9rem;">Erledigt</span>';
        } else {
          actionBtn = `<button class="check-btn" onclick="markTaskDone(${task.id})"><span class="icon" aria-hidden="true">âœ”ï¸</span> Erledigen</button>`;
        }

        container.innerHTML += `
          <div class="${cardClass}">
            <h3 style="margin:0 0 10px 0;">
              ${task.title}
              ${badge}
            </h3>
            <p style="color:var(--text-muted); font-size:0.95rem; margin-bottom:5px;">${task.desc || ''}</p>
            ${dateHTML}
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
              <span style="font-size:0.75rem; color:var(--text-muted); background:rgba(255,255,255,0.05); padding:2px 8px; border-radius:4px;">${task.group}</span>
              ${actionBtn}
            </div>
          </div>
        `;
      });
    }

    function markTaskDone(taskId) {
      const db = getDB();
      const task = db.tasks.find(t => t.id === taskId);
      
      if(task) {
        if(!task.completedBy) task.completedBy = [];
        if(!task.completedBy.includes(currentUser.name)) {
          task.completedBy.push(currentUser.name);
          localStorage.setItem(DB_KEY, JSON.stringify(db));
          loadWorkplaceData();
        }
      }
    }
  </script>
</body>
</html>